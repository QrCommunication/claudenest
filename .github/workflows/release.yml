name: Release & Deploy

on:
  push:
    tags:
      - 'v*'
      - 'agent-v*'
      - 'server-v*'

jobs:
  # ============================================
  # Create GitHub Release
  # ============================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version info
        id: info
        env:
          TAG_REF: ${{ github.ref }}
        run: |
          TAG="${TAG_REF#refs/tags/}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

          if [[ $TAG == agent-v* ]]; then
            echo "package=agent" >> "$GITHUB_OUTPUT"
            echo "name=ClaudeNest Agent" >> "$GITHUB_OUTPUT"
          elif [[ $TAG == server-v* ]]; then
            echo "package=server" >> "$GITHUB_OUTPUT"
            echo "name=ClaudeNest Server" >> "$GITHUB_OUTPUT"
          else
            echo "package=all" >> "$GITHUB_OUTPUT"
            echo "name=ClaudeNest" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          {
            echo "changelog<<EOF"
            if [ -n "$PREV_TAG" ]; then
              git log --pretty=format:"- %s" "${PREV_TAG}..HEAD"
            else
              echo "- Initial release"
            fi
            echo ""
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: "${{ steps.info.outputs.name }} ${{ steps.info.outputs.tag }}"
          body: |
            ### Installation

            **Agent:**
            ```bash
            curl -fsSL https://claudenest.io/install-agent.sh | bash
            ```

            **Server:**
            See [Deployment Guide](docs/DEPLOYMENT-BAREMETAL.md)
          draft: false

  # ============================================
  # Deploy Server to Production (v* tags only)
  # ============================================
  deploy-server:
    name: Deploy Server
    runs-on: ubuntu-latest
    needs: release
    if: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, 'alpha') && !contains(github.ref, 'beta') && !contains(github.ref, 'rc')
    environment: production

    steps:
      - name: Deploy to production
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: bash /var/www/claudenest/deploy.sh
