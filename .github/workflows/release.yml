name: ðŸš€ Release Workflow

on:
  push:
    tags:
      - 'v*'
      - 'agent-v*'
      - 'server-v*'
      - 'mobile-v*'

jobs:
  # ============================================
  # Create GitHub Release
  # ============================================
  release:
    name: ðŸ“¦ Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version info
        id: info
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          
          if [[ $TAG == agent-v* ]]; then
            echo "package=agent" >> $GITHUB_OUTPUT
            echo "name=ClaudeNest Agent" >> $GITHUB_OUTPUT
          elif [[ $TAG == server-v* ]]; then
            echo "package=server" >> $GITHUB_OUTPUT
            echo "name=ClaudeNest Server" >> $GITHUB_OUTPUT
          elif [[ $TAG == mobile-v* ]]; then
            echo "package=mobile" >> $GITHUB_OUTPUT
            echo "name=ClaudeNest Mobile" >> $GITHUB_OUTPUT
          else
            echo "package=all" >> $GITHUB_OUTPUT
            echo "name=ClaudeNest" >> $GITHUB_OUTPUT
          fi

      - name: Generate changelog
        id: changelog
        run: |
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 HEAD^)..HEAD >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.info.outputs.tag }}
          release_name: ${{ steps.info.outputs.name }} ${{ steps.info.outputs.tag }}
          body: |
            ## ${{ steps.info.outputs.name }} ${{ steps.info.outputs.tag }}
            
            ### Changes
            ${{ steps.changelog.outputs.changelog }}
            
            ### Installation
            
            **Agent:**
            ```bash
            npm install -g @claude-remote/agent
            ```
            
            **Server:**
            See [Deployment Guide](docs/DEPLOYMENT-BAREMETAL.md)
            
            **Mobile:**
            Download from [Releases](https://github.com/${{ github.repository }}/releases)
          draft: false
          prerelease: ${{ contains(steps.info.outputs.tag, 'alpha') || contains(steps.info.outputs.tag, 'beta') || contains(steps.info.outputs.tag, 'rc') }}

  # ============================================
  # Deploy to Production (tagged releases only)
  # ============================================
  deploy-production:
    name: ðŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: release
    if: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, 'alpha') && !contains(github.ref, 'beta') && !contains(github.ref, 'rc')
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            cd /opt/claudenest
            git fetch origin
            git checkout ${{ github.ref_name }}
            git pull origin ${{ github.ref_name }}
            
            # Update dependencies
            cd packages/server
            composer install --no-dev --optimize-autoloader
            npm ci && npm run build
            
            # Run migrations
            php artisan migrate --force
            
            # Clear caches
            php artisan optimize
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            
            # Restart services
            sudo systemctl restart claudenest-reverb
            sudo systemctl restart claudenest-queue
            
            echo "Deployment completed!"
