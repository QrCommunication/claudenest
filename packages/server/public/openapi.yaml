openapi: 3.0.3
info:
  title: ClaudeNest API
  description: |
    ClaudeNest API for managing Claude Code sessions, machines, and multi-agent projects.
    
    ## Authentication
    All API requests require authentication via Bearer token in the Authorization header:
    ```
    Authorization: Bearer YOUR_API_TOKEN
    ```
    
    ## Rate Limiting
    - Authenticated requests: 1,000 requests per hour
    - Authentication endpoints: 10 requests per minute
    
    ## Base URL
    ```
    https://api.claudenest.io/api
    ```
  version: 1.0.0
  contact:
    name: ClaudeNest Support
    email: support@claudenest.io
    url: https://claudenest.io/support
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: https://api.claudenest.io/api
    description: Production server
  - url: http://localhost:8000/api
    description: Development server

security:
  - bearerAuth: []

paths:
  # Health Check
  /health:
    get:
      tags:
        - System
      summary: Health check
      description: Check API availability and get version information
      security: []
      responses:
        '200':
          description: API is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
              example:
                success: true
                data:
                  status: ok
                  version: 1.0.0
                  timestamp: '2026-02-02T15:30:00Z'
                meta:
                  timestamp: '2026-02-02T15:30:00Z'

  # Authentication
  /auth/login:
    post:
      tags:
        - Authentication
      summary: Login
      description: Authenticate with email and password
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  format: password
                remember:
                  type: boolean
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/register:
    post:
      tags:
        - Authentication
      summary: Register
      description: Register a new user account
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - email
                - password
                - password_confirmation
              properties:
                name:
                  type: string
                email:
                  type: string
                  format: email
                password:
                  type: string
                  minLength: 8
                password_confirmation:
                  type: string
      responses:
        '201':
          description: Registration successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '422':
          description: Validation error

  /auth/logout:
    post:
      tags:
        - Authentication
      summary: Logout
      description: Revoke the current API token
      responses:
        '200':
          description: Logout successful

  /auth/me:
    get:
      tags:
        - Authentication
      summary: Get current user
      description: Get information about the authenticated user
      responses:
        '200':
          description: User information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'

  /auth/refresh:
    post:
      tags:
        - Authentication
      summary: Refresh token
      description: Get a new API token
      responses:
        '200':
          description: Token refreshed
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      token:
                        type: string
                      expires_at:
                        type: string
                        format: date-time

  /auth/tokens:
    get:
      tags:
        - Authentication
      summary: List tokens
      description: List all API tokens for the current user
      responses:
        '200':
          description: List of tokens
    post:
      tags:
        - Authentication
      summary: Create token
      description: Create a new personal access token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
                abilities:
                  type: array
                  items:
                    type: string
                expires_in_days:
                  type: integer
      responses:
        '201':
          description: Token created

  /auth/tokens/{id}:
    delete:
      tags:
        - Authentication
      summary: Revoke token
      description: Revoke a specific API token
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Token revoked
        '404':
          description: Token not found

  # Machines
  /machines:
    get:
      tags:
        - Machines
      summary: List machines
      description: List all machines for the authenticated user
      parameters:
        - name: per_page
          in: query
          schema:
            type: integer
            default: 15
        - name: search
          in: query
          schema:
            type: string
        - name: status
          in: query
          schema:
            type: string
            enum: [online, offline, connecting, error, maintenance]
      responses:
        '200':
          description: List of machines
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MachineListResponse'

    post:
      tags:
        - Machines
      summary: Create machine
      description: Register a new machine
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateMachineRequest'
      responses:
        '201':
          description: Machine created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MachineResponse'

  /machines/{id}:
    get:
      tags:
        - Machines
      summary: Get machine
      description: Get detailed information about a machine
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Machine details
        '404':
          description: Machine not found

    patch:
      tags:
        - Machines
      summary: Update machine
      description: Update machine configuration
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                max_sessions:
                  type: integer
      responses:
        '200':
          description: Machine updated

    delete:
      tags:
        - Machines
      summary: Delete machine
      description: Delete a machine and all its sessions
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Machine deleted

  /machines/{id}/regenerate-token:
    post:
      tags:
        - Machines
      summary: Regenerate machine token
      description: Generate a new authentication token for the machine
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: New token generated

  /machines/{id}/environment:
    get:
      tags:
        - Machines
      summary: Get environment
      description: Get machine environment information
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Environment information
        '400':
          description: Machine is offline

  /machines/{id}/wake:
    post:
      tags:
        - Machines
      summary: Wake-on-LAN
      description: Send a Wake-on-LAN signal to the machine
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Wake signal sent
        '400':
          description: Machine doesn't support Wake-on-LAN or is already online

  # Sessions
  /machines/{machine}/sessions:
    get:
      tags:
        - Sessions
      summary: List sessions
      description: List all sessions for a machine
      parameters:
        - name: machine
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: per_page
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: List of sessions

    post:
      tags:
        - Sessions
      summary: Create session
      description: Create a new Claude Code session
      parameters:
        - name: machine
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSessionRequest'
      responses:
        '201':
          description: Session created
        '400':
          description: Machine is offline

  /sessions/{id}:
    get:
      tags:
        - Sessions
      summary: Get session
      description: Get detailed information about a session
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Session details
        '404':
          description: Session not found

    delete:
      tags:
        - Sessions
      summary: Terminate session
      description: Terminate a running session
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Session terminated
        '400':
          description: Session already terminated

  /sessions/{id}/logs:
    get:
      tags:
        - Sessions
      summary: Get session logs
      description: Get the complete log history for a session
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: per_page
          in: query
          schema:
            type: integer
            default: 100
      responses:
        '200':
          description: Session logs

  /sessions/{id}/attach:
    post:
      tags:
        - Sessions
      summary: Attach to session
      description: Generate a WebSocket token for real-time session interaction
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: WebSocket token generated
          content:
            application/json:
              schema:
                type: object
                properties:
                  ws_token:
                    type: string
                  session_id:
                    type: string
                  ws_url:
                    type: string
        '404':
          description: Session not found or not running

  /sessions/{id}/input:
    post:
      tags:
        - Sessions
      summary: Send input
      description: Send input to a running session
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - data
              properties:
                data:
                  type: string
      responses:
        '200':
          description: Input sent

  /sessions/{id}/resize:
    post:
      tags:
        - Sessions
      summary: Resize PTY
      description: Resize the terminal dimensions
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - cols
                - rows
              properties:
                cols:
                  type: integer
                  minimum: 20
                  maximum: 500
                rows:
                  type: integer
                  minimum: 10
                  maximum: 200
      responses:
        '200':
          description: PTY resized

  # Projects
  /machines/{machine}/projects:
    get:
      tags:
        - Projects
      summary: List projects
      description: List all projects for a machine
      parameters:
        - name: machine
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of projects

    post:
      tags:
        - Projects
      summary: Create project
      description: Create a new shared project
      parameters:
        - name: machine
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateProjectRequest'
      responses:
        '201':
          description: Project created
        '422':
          description: Project already exists for this path

  /projects/{id}:
    get:
      tags:
        - Projects
      summary: Get project
      description: Get detailed project information
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Project details
        '404':
          description: Project not found

    patch:
      tags:
        - Projects
      summary: Update project
      description: Update project configuration and context
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                summary:
                  type: string
                architecture:
                  type: string
                conventions:
                  type: string
                current_focus:
                  type: string
                recent_changes:
                  type: string
                max_tokens:
                  type: integer
      responses:
        '200':
          description: Project updated

    delete:
      tags:
        - Projects
      summary: Delete project
      description: Delete a project and all associated data
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Project deleted

  /projects/{id}/stats:
    get:
      tags:
        - Projects
      summary: Get project stats
      description: Get project statistics
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Project statistics

  /projects/{id}/instances:
    get:
      tags:
        - Projects
      summary: Get instances
      description: Get all active instances in the project
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of instances

  /projects/{id}/activity:
    get:
      tags:
        - Projects
      summary: Get activity
      description: Get recent activity logs
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: since
          in: query
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Activity logs

  /projects/{id}/broadcast:
    post:
      tags:
        - Projects
      summary: Broadcast message
      description: Broadcast a message to all instances
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - message
              properties:
                message:
                  type: string
                type:
                  type: string
                  enum: [info, warning, error, success]
                  default: info
                target_instances:
                  type: array
                  items:
                    type: string
      responses:
        '200':
          description: Message broadcasted

  # Tasks
  /projects/{project}/tasks:
    get:
      tags:
        - Tasks
      summary: List tasks
      description: List all tasks in a project
      parameters:
        - name: project
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, in_progress, blocked, review, done]
        - name: priority
          in: query
          schema:
            type: string
            enum: [low, medium, high, critical]
        - name: per_page
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: List of tasks

    post:
      tags:
        - Tasks
      summary: Create task
      description: Create a new task
      parameters:
        - name: project
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTaskRequest'
      responses:
        '201':
          description: Task created

  /projects/{project}/tasks/next-available:
    get:
      tags:
        - Tasks
      summary: Get next available task
      description: Get the next task that can be claimed (dependencies met)
      parameters:
        - name: project
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Next available task or null

  /tasks/{id}:
    get:
      tags:
        - Tasks
      summary: Get task
      description: Get detailed task information
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Task details

    patch:
      tags:
        - Tasks
      summary: Update task
      description: Update task details
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                description:
                  type: string
                priority:
                  type: string
                  enum: [low, medium, high, critical]
                files:
                  type: array
                  items:
                    type: string
      responses:
        '200':
          description: Task updated

    delete:
      tags:
        - Tasks
      summary: Delete task
      description: Delete a task
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Task deleted

  /tasks/{id}/claim:
    post:
      tags:
        - Tasks
      summary: Claim task
      description: Claim a task for an instance
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - instance_id
              properties:
                instance_id:
                  type: string
      responses:
        '200':
          description: Task claimed
        '409':
          description: Task already claimed
        '400':
          description: Dependencies not completed

  /tasks/{id}/release:
    post:
      tags:
        - Tasks
      summary: Release task
      description: Release a claimed task
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
      responses:
        '200':
          description: Task released

  /tasks/{id}/complete:
    post:
      tags:
        - Tasks
      summary: Complete task
      description: Mark a task as completed
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - summary
                - instance_id
              properties:
                summary:
                  type: string
                files_modified:
                  type: array
                  items:
                    type: string
                instance_id:
                  type: string
      responses:
        '200':
          description: Task completed
        '400':
          description: Task not claimed

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    SuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
        meta:
          type: object
          properties:
            timestamp:
              type: string
              format: date-time
            request_id:
              type: string

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string
        meta:
          type: object

    AuthResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                user:
                  $ref: '#/components/schemas/User'
                token:
                  type: string
                expires_at:
                  type: string
                  format: date-time

    UserResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                user:
                  $ref: '#/components/schemas/User'

    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        name:
          type: string
        avatar_url:
          type: string
          nullable: true
        email_verified_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time

    Machine:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        platform:
          type: string
          enum: [darwin, linux, win32]
        hostname:
          type: string
        arch:
          type: string
        status:
          type: string
          enum: [online, offline, connecting, error, maintenance]
        is_online:
          type: boolean
        capabilities:
          type: array
          items:
            type: string
        max_sessions:
          type: integer
        active_sessions_count:
          type: integer

    MachineListResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              type: array
              items:
                $ref: '#/components/schemas/Machine'

    MachineResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                machine:
                  $ref: '#/components/schemas/Machine'
                token:
                  type: string

    CreateMachineRequest:
      type: object
      required:
        - name
        - platform
      properties:
        name:
          type: string
        platform:
          type: string
          enum: [darwin, linux, win32]
        hostname:
          type: string
        arch:
          type: string
        capabilities:
          type: array
          items:
            type: string
        max_sessions:
          type: integer
          default: 10

    Session:
      type: object
      properties:
        id:
          type: string
          format: uuid
        machine_id:
          type: string
          format: uuid
        mode:
          type: string
          enum: [interactive, headless, oneshot]
        project_path:
          type: string
          nullable: true
        status:
          type: string
          enum: [created, starting, running, waiting_input, completed, error, terminated]
        is_running:
          type: boolean
        pid:
          type: integer
          nullable: true
        exit_code:
          type: integer
          nullable: true
        pty_size:
          type: object
          properties:
            cols:
              type: integer
            rows:
              type: integer
        total_tokens:
          type: integer
        total_cost:
          type: number
        duration:
          type: integer

    CreateSessionRequest:
      type: object
      properties:
        mode:
          type: string
          enum: [interactive, headless, oneshot]
          default: interactive
        project_path:
          type: string
        initial_prompt:
          type: string
        pty_size:
          type: object
          properties:
            cols:
              type: integer
              minimum: 20
              maximum: 500
            rows:
              type: integer
              minimum: 10
              maximum: 200

    Project:
      type: object
      properties:
        id:
          type: string
          format: uuid
        machine_id:
          type: string
          format: uuid
        name:
          type: string
        project_path:
          type: string
        summary:
          type: string
        architecture:
          type: string
        conventions:
          type: string
        total_tokens:
          type: integer
        max_tokens:
          type: integer
        token_usage_percent:
          type: integer

    CreateProjectRequest:
      type: object
      required:
        - name
        - project_path
      properties:
        name:
          type: string
        project_path:
          type: string
        summary:
          type: string
        architecture:
          type: string
        conventions:
          type: string
        settings:
          type: object

    Task:
      type: object
      properties:
        id:
          type: string
          format: uuid
        project_id:
          type: string
          format: uuid
        title:
          type: string
        description:
          type: string
        priority:
          type: string
          enum: [low, medium, high, critical]
        status:
          type: string
          enum: [pending, in_progress, blocked, review, done]
        is_claimed:
          type: boolean
        is_completed:
          type: boolean
        assigned_to:
          type: string
          nullable: true
        files:
          type: array
          items:
            type: string
        dependencies:
          type: array
          items:
            type: string
            format: uuid

    CreateTaskRequest:
      type: object
      required:
        - title
      properties:
        title:
          type: string
        description:
          type: string
        priority:
          type: string
          enum: [low, medium, high, critical]
          default: medium
        files:
          type: array
          items:
            type: string
        estimated_tokens:
          type: integer
        dependencies:
          type: array
          items:
            type: string
            format: uuid
