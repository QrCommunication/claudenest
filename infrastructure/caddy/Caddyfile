# ClaudeNest API - serves both REST API and WebSocket
api.claudenest.io {
    # Match non-WebSocket routes for CORS and compression
    @not_ws {
        not path /ws/agent /app/* /apps/*
    }

    # CORS headers only for non-WebSocket routes
    header @not_ws {
        Access-Control-Allow-Origin "https://claudenest.io"
        Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
        Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, X-Request-ID, X-Machine-Token, X-Machine-ID"
        Access-Control-Allow-Credentials "true"
        Access-Control-Max-Age "86400"
    }

    # Handle CORS preflight
    @options method OPTIONS
    respond @options 204

    # WebSocket: Reverb handles /app/* and /apps/* paths
    @reverb path /app/* /apps/*
    handle @reverb {
        reverse_proxy localhost:8080 {
            flush_interval -1
        }
    }

    # WebSocket: Agent custom WS endpoint â†’ dedicated server on port 6001
    @agent_ws path /ws/agent
    handle @agent_ws {
        reverse_proxy localhost:6001 {
            flush_interval -1
        }
    }

    # Broadcasting auth (needed for private channels)
    @broadcasting path /broadcasting/auth
    handle @broadcasting {
        reverse_proxy unix//run/php/php8.3-fpm.sock {
            transport fastcgi {
                root /var/www/claudenest/packages/server/public
                split .php
            }
        }
    }

    # All other requests -> PHP-FPM
    handle {
        root * /var/www/claudenest/packages/server/public
        try_files {path} {path}/ /index.php
        file_server
        php_fastcgi unix//run/php/php8.3-fpm.sock
    }

    # Compression only for non-WebSocket routes
    encode @not_ws gzip zstd
}

# Main application (web dashboard + landing)
claudenest.io {
    # WebSocket: Reverb proxy for real-time terminal
    @reverb path /app/* /apps/*
    handle @reverb {
        reverse_proxy localhost:8080 {
            flush_interval -1
        }
    }

    root * /var/www/claudenest/packages/server/public

    # Try files - SPA fallback via PHP
    try_files {path} {path}/ /index.php

    # File server for static assets
    file_server

    # PHP for all routes
    php_fastcgi unix//run/php/php8.3-fpm.sock

    # Enable compression
    encode gzip zstd

    # Security headers
    header {
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
    }
}

# App subdomain (alias for main app)
app.claudenest.io {
    root * /var/www/claudenest/packages/server/public
    try_files {path} {path}/ /index.php
    file_server
    php_fastcgi unix//run/php/php8.3-fpm.sock
    encode gzip zstd
}
